<!-- settingsModal.html -->
<div id="settingsModal" style="display:none;">

  <div id="modalFrameShape"></div>
  <div id="modalCloseBtn" class="modal-close-btn" title="Close">&times;</div>
  <div class="modal-content">

		<div id="settingsModalMoveBar"
			 style="width:100%;height:32px;cursor:move;
					background: linear-gradient(to bottom, #232c38 88%, transparent);
					border-radius: 18px 18px 0 0;
					position: absolute;left:0;top:0;z-index:1010;
					display:flex;align-items:center;">
		  <span style="padding-left:16px;font-weight:bold;color:#98c7ff;user-select:none;">
			⚙️ Settings
		  </span>
		</div>

	  <div style="position: relative; z-index: 1002;">
			<!-- Tab Button Row (restore this block!) -->
			<div style="display:flex; justify-content:space-around; margin-top:24px; margin-bottom:10px;">
			  <button class="tabButton" onclick="showTab('keysTab', this)">Controls</button>
			  <button class="tabButton" onclick="showTab('camTab', this)">Camera</button>
			  <button class="tabButton" onclick="showTab('robotTab', this)">Config</button>
			  <button class="tabButton" onclick="showTab('telemetryTab', this)">Telemetry</button>
			  <button class="tabButton" onclick="showTab('wifiTab', this)">Wi-Fi</button>
				<button class="tabButton" onclick="showTab('mqttTab', this)">MQTT</button>
				<button class="tabButton" onclick="showTab('mediaTab', this)">Media</button>
			  <button class="tabButton" onclick="showTab('sdTab', this)">SD Card</button>
			  <button class="tabButton" onclick="showTab('oledTab', this)">OLED</button>
			  <button class="tabButton" onclick="showTab('otaTab', this)">FW</button>
			</div>


		<div id="tabContentWrapper" class="tabContentWrapper">

			<!-- KEY CONFIG TAB -->
			<div id="keysTab" class="tabContent" style="display:none;">
				<h3>Controls</h3>

				<!-- top sub-tabs -->
				<div class="subTabBar">
					<button class="subTabBtn active" onclick="showControlSubTab('kb', this)">Keyboard Controls</button>
					<button class="subTabBtn"        onclick="showControlSubTab('joy', this)">Joystick Controls</button>
				</div>

				<!-- KEYBOARD SECTION -->
				<div id="kbSection" class="subSection active">
					<!-- keyboard inner subtabs -->
					<div class="subSubTabBar">
						<button class="subSubBtn active" onclick="showKeyboardPane('move', this)">Movement</button>
						<button class="subSubBtn"        onclick="showKeyboardPane('claw', this)">Claw/Arm</button>
						<button class="subSubBtn"        onclick="showKeyboardPane('lights', this)">Speaker/Lights</button>
					</div>

					<!-- keep all selects under this container so your existing JS still finds them -->
					<div id="keyMappingInputs">

						<!-- MOVEMENT -->
						<div id="kbMovePane" class="subPane active">
							<div class="imgMap">
								<img src="/img/rover_move.webp" alt="Movement map" width="519" height="322">
								<!-- TL: forward -->
								<div class="slot pos-tl">
									<label>Forward</label>
									<select data-action="forward"></select><span class="dupWarn"></span>
								</div>
								<!-- BL: left -->
								<div class="slot pos-bl">
									<label>Left</label>
									<select data-action="left"></select><span class="dupWarn"></span>
								</div>
								<!-- TR: right -->
								<div class="slot pos-tr">
									<label>Right</label>
									<select data-action="right"></select><span class="dupWarn"></span>
								</div>
								<!-- BR: backward -->
								<div class="slot pos-br">
									<label>Backward</label>
									<select data-action="backward"></select><span class="dupWarn"></span>
								</div>
								<!-- bottom center: stop -->
								<div class="slot pos-bc">
									<label>Stop (Space)</label>
									<select data-action="stop"></select><span class="dupWarn"></span>
								</div>
							</div>
						</div>

						<!-- CLAW / ARM -->
						<div id="kbClawPane" class="subPane">
							<div class="imgMap">
								<img src="/img/rover_claw.webp" alt="Claw/Arm map" width="640" height="360">
								<!-- UL: bucket down -->
								<div class="slot pos-tl">
									<label>Bucket Down</label>
									<select data-action="bucketDown"></select><span class="dupWarn"></span>
								</div>
								<!-- top center: bucket up -->
								<div class="slot pos-tc">
									<label>Bucket Up</label>
									<select data-action="bucketUp"></select><span class="dupWarn"></span>
								</div>
								<!-- left mid-high: aux up -->
								<div class="slot pos-lc-up">
									<label>AUX Up</label>
									<select data-action="auxUp"></select><span class="dupWarn"></span>
								</div>
								<!-- left lower: aux down -->
								<div class="slot pos-lb">
									<label>AUX Down</label>
									<select data-action="auxDown"></select><span class="dupWarn"></span>
								</div>
								<!-- right upper: arm down -->
								<div class="slot pos-tr">
									<label>Arm Down</label>
									<select data-action="armDown"></select><span class="dupWarn"></span>
								</div>
								<!-- right near lower: arm up -->
								<div class="slot pos-rb-up">
									<label>Arm Up</label>
									<select data-action="armUp"></select><span class="dupWarn"></span>
								</div>
							</div>
						</div>

						<!-- SPEAKER / LIGHTS -->
						<div id="kbLightsPane" class="subPane">
							<div class="imgMap">
								<img src="/img/rover_speaker.webp" alt="Speaker/Lights map" width="557" height="360">
								<!-- left column -->
								<div class="slot pos-left-col">
									<label>Horn</label>
									<select data-action="horn"></select><span class="dupWarn"></span>

									<!-- future: horn sound (populate later from /web/pcm) -->
									<label style="margin-top:8px;">Horn Sound</label>
									<select id="hornSoundSel"><option value="">(default)</option></select>
								</div>

								<!-- right column -->
								<div class="slot pos-right-col">
									<label>LED Toggle</label>
									<select data-action="led"></select><span class="dupWarn"></span>

									<label style="margin-top:8px;">Beacon Toggle</label>
									<select data-action="beacon"></select><span class="dupWarn"></span>

									<label style="margin-top:8px;">Emergency Toggle</label>
									<select data-action="emergency"></select><span class="dupWarn"></span>
								</div>
							</div>
						</div>
					</div><!-- /keyMappingInputs -->

					<hr style="margin-top:16px;">
					<div style="display:flex; gap:10px; justify-content:center;">
						<button onclick="saveKeyMappings()" class="ctrlBtn">Save Mappings</button>
						<button onclick="resetToDefaultKeymap()" class="ctrlBtn">Reset to Defaults</button>
					</div>
					<div id="keySaveStatus" style="margin-top:8px; font-size:90%; color:lightgreen; text-align:center;"></div>
				</div><!-- /kbSection -->

				<!-- JOYSTICK SECTION -->
				<div id="joySection" class="subSection">
					<div id="joyMappingInputs">

						<!-- Image + positioned selects -->
						<div class="imgMap" style="position:relative; max-width:680px; margin:10px auto;">
							<img src="/img/controller.webp" alt="Gamepad map" style="width:100%; height:auto; display:block;">

							<!-- DPAD -->
							<div class="slot" style="position:absolute; left:33%; top:56%; transform:translate(-50%,-50%);">
								<label>DPAD ↑</label>
								<select class="joySelect" data-btn="DPAD_UP"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:29%; top:62%; transform:translate(-50%,-50%);">
								<label>DPAD ←</label>
								<select class="joySelect" data-btn="DPAD_LEFT"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:33%; top:67%; transform:translate(-50%,-50%);">
								<label>DPAD ↓</label>
								<select class="joySelect" data-btn="DPAD_DOWN"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:37%; top:62%; transform:translate(-50%,-50%);">
								<label>DPAD →</label>
								<select class="joySelect" data-btn="DPAD_RIGHT"></select><span class="dupWarn"></span>
							</div>

							<!-- ABXY cluster -->
							<div class="slot" style="position:absolute; left:61%; top:61%; transform:translate(-50%,-50%);">
								<label>X</label>
								<select class="joySelect" data-btn="X"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:64%; top:56%; transform:translate(-50%,-50%);">
								<label>Y</label>
								<select class="joySelect" data-btn="Y"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:68%; top:61%; transform:translate(-50%,-50%);">
								<label>B</label>
								<select class="joySelect" data-btn="B"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:64%; top:66%; transform:translate(-50%,-50%);">
								<label>A</label>
								<select class="joySelect" data-btn="A"></select><span class="dupWarn"></span>
							</div>

							<!-- Shoulders & triggers -->
							<div class="slot" style="position:absolute; left:5%; top:28%; transform:translate(-50%,-50%);">
								<label>LB / L1</label>
								<select class="joySelect" data-btn="L1"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:5%; top:18%; transform:translate(-50%,-50%);">
								<label>LT / L2 (click)</label>
								<select class="joySelect" data-btn="L2_CLICK"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:70%; top:21%; transform:translate(-50%,-50%);">
								<label>RB / R1</label>
								<select class="joySelect" data-btn="R1"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:70%; top:13%; transform:translate(-50%,-50%);">
								<label>RT / R2 (click)</label>
								<select class="joySelect" data-btn="R2_CLICK"></select><span class="dupWarn"></span>
							</div>

							<!-- Stick clicks -->
							<div class="slot" style="position:absolute; left:44%; top:60%; transform:translate(-50%,-50%);">
								<label>L3 (stick)</label>
								<select class="joySelect" data-btn="L3"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:56%; top:65%; transform:translate(-50%,-50%);">
								<label>R3 (stick)</label>
								<select class="joySelect" data-btn="R3"></select><span class="dupWarn"></span>
							</div>

							<!-- Center buttons -->
							<div class="slot" style="position:absolute; left:49%; top:16%; transform:translate(-50%,-50%);">
								<label>Back / Select</label>
								<select class="joySelect" data-btn="BTN_BACK"></select><span class="dupWarn"></span>
							</div>
							<div class="slot" style="position:absolute; left:55%; top:16%; transform:translate(-50%,-50%);">
								<label>Start</label>
								<select class="joySelect" data-btn="BTN_START"></select><span class="dupWarn"></span>
							</div>
						</div>

						<hr style="margin-top:16px;">
						<div style="display:flex; gap:10px; justify-content:center;">
							<button onclick="saveJoyMappings()" class="ctrlBtn">Save Joystick Mappings</button>
							<button onclick="resetToDefaultJoymap()" class="ctrlBtn">Reset to Defaults</button>
						</div>
						<div id="joySaveStatus" style="margin-top:8px; font-size:90%; color:lightgreen; text-align:center;"></div>
					</div>
				</div>

			</div>


		<!-- CAM CONFIG TAB -->
		<div id="camTab" class="tabContent active">
		  <h3>Camera Settings</h3><br>
			<div id="camModelInfo" style="font-weight:bold; margin-bottom:8px;">
				Camera Model: <span id="camModelName">...</span>
			</div><br>

		  <div class="camSettingsScroll">

			<label for="camResolution">Resolution:</label>
			<select id="camResolution">
			  <option value="0">96x96</option>
			  <option value="1">QQVGA (160x120)</option>
			  <option value="2">QCIF (176x144)</option>
			  <option value="3">QVGA (320x240)</option>
			  <option value="4">CIF (352x288)</option>
			  <option value="5">VGA (640x480)</option>
			  <option value="6">SVGA (800x600)</option>
			  <option value="7">XGA (1024x768)</option>
			  <option value="8">HD (1280x720)</option>
			  <option value="9">SXGA (1280x1024)</option>
			  <option value="10">UXGA (1600x1200)</option>
			  <option value="11">FHD (1920x1080)</option>
			  <option value="12">P_HD (720x1280)</option>
			  <option value="13">P_3MP (864x1536)</option>
			  <option value="14">QXGA (2048x1536)</option>
			  <option value="15">QHD (2560x1440)</option>
			  <option value="16">WQXGA (2560x1600)</option>
			  <option value="17">P_FHD (1080x1920)</option>
			  <option value="18">QSXGA (2560x1920)</option>
			</select><br><br>

			<label for="camFPS">Sensor Clock (XCLK MHz):</label>
			<input type="number" id="camFPS" value="10" min="10" max="24" step="1"><br><br>

			<label for="camQuality">JPEG Quality:</label>
			<input type="range" min="10" max="63" value="10" id="camQuality" oninput="updateSliderValue('camQuality')">
			<span id="camQualityValue">10</span>
			<small style="display:block; margin-bottom:10px;">10 = Best, 63 = Worst</small><br><br>

			<label for="camSaturation">Saturation: </label>
			<input type="range" min="-2" max="2" value="0" id="camSaturation" oninput="updateSliderValue('camSaturation')">
			<span id="camSaturationValue">0</span><br><br>

			<label for="camBrightness">Brightness:</label>
			<input type="range" min="-2" max="2" value="0" id="camBrightness" oninput="updateSliderValue('camBrightness')">
			<span id="camBrightnessValue">0</span><br><br>

			<label for="camContrast">Contrast:</label>
			<input type="range" min="-2" max="2" value="0" id="camContrast" oninput="updateSliderValue('camContrast')">
			<span id="camContrastValue">0</span><br><br>

			<label for="camSharpness">Sharpness:</label>
			<input type="range" min="0" max="3" value="2" id="camSharpness" oninput="updateSliderValue('camSharpness')">
			<span id="camSharpnessValue">2</span><br><br>

			<label for="ledBrightness">LED Brightness:</label>
			<input type="range" min="0" max="255" value="0" id="ledBrightness" oninput="updateSliderValue('ledBrightness')">
			<span id="ledBrightnessValue">0</span><br><br>

			<label for="camGamma">Gamma:</label>
			<input type="range" min="0" max="3" value="0" id="camGamma" oninput="updateSliderValue('camGamma')">
			<span id="camGammaValue">0</span><br><br>

			<label for="camCompression">Compression:</label>
			<input type="range" min="0" max="63" value="12" id="camCompression" oninput="updateSliderValue('camCompression')">
			<span id="camCompressionValue">12</span><br><br>

			<!-- Switches -->
			<label class="switch-label" for="camDenoise">Denoise (DCW):</label>
			<label class="switch">
			  <input type="checkbox" id="camDenoise">
			  <span class="slider"></span>
			</label><br><br>

			<label for="camGainceiling">Gain Ceiling:</label>
			<div id="camGainceilingGroup">
			  <label><input type="radio" name="camGainceiling" value="0">2x</label>
			  <label><input type="radio" name="camGainceiling" value="1">4x</label>
			  <label><input type="radio" name="camGainceiling" value="2">8x</label>
			  <label><input type="radio" name="camGainceiling" value="3">16x</label>
			  <label><input type="radio" name="camGainceiling" value="4">32x</label>
			  <label><input type="radio" name="camGainceiling" value="5">64x</label>
			  <label><input type="radio" name="camGainceiling" value="6">128x</label>
			</div><br>

			<label class="switch-label" for="camColorbar">Colorbar:</label>
			<label class="switch">
			  <input type="checkbox" id="camColorbar">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camGrayscale">Grayscale:</label>
			<label class="switch">
			  <input type="checkbox" id="camGrayscale">
			  <span class="slider"></span>
			</label><br><br>

			<label for="camRotate">Rotate:</label>
			<div id="camRotateGroup">
			  <label><input type="radio" name="camRotate" value="0">Normal</label>
			  <label><input type="radio" name="camRotate" value="1">H Mirror</label>
			  <label><input type="radio" name="camRotate" value="2">V Flip</label>
			  <label><input type="radio" name="camRotate" value="3">Mirror + Flip</label>
			</div><br>

			<label class="switch-label" for="camAWB">Auto White Balance (AWB):</label>
			<label class="switch">
			  <input type="checkbox" id="camAWB">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camAWBGain">AWB Gain:</label>
			<label class="switch">
			  <input type="checkbox" id="camAWBGain">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camAGC">Auto Gain Control (AGC):</label>
			<label class="switch">
			  <input type="checkbox" id="camAGC">
			  <span class="slider"></span>
			</label><br><br>

			<label for="camAGCGain">AGC Gain:</label>
			<input type="range" min="0" max="30" value="0" id="camAGCGain" oninput="updateSliderValue('camAGCGain')">
			<span id="camAGCGainValue">0</span><br><br>

			<label class="switch-label" for="camAEC">Auto Exposure Control (AEC):</label>
			<label class="switch">
			  <input type="checkbox" id="camAEC">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camAEC2">AEC2:</label>
			<label class="switch">
			  <input type="checkbox" id="camAEC2">
			  <span class="slider"></span>
			</label><br><br>

			<label for="camAECValue">AEC Value:</label>
			<input type="range" min="0" max="1200" value="0" id="camAECValue" oninput="updateSliderValue('camAECValue')">
			<span id="camAECValueValue">0</span><br><br>

			<label class="switch-label" for="camBPC">Bad Pixel Correction (BPC):</label>
			<label class="switch">
			  <input type="checkbox" id="camBPC">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camWPC">White Pixel Correction (WPC):</label>
			<label class="switch">
			  <input type="checkbox" id="camWPC">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camRawGMA">Raw Gamma (Raw GMA):</label>
			<label class="switch">
			  <input type="checkbox" id="camRawGMA">
			  <span class="slider"></span>
			</label><br><br>

			<label class="switch-label" for="camLENC">Lens Correction (LENC):</label>
			<label class="switch">
			  <input type="checkbox" id="camLENC">
			  <span class="slider"></span>
			</label><br><br>

			<label for="camSpecialEffect">Special Effect:</label>
			<div id="camSpecialEffectGroup">
			  <label><input type="radio" name="camSpecialEffect" value="0">None</label>
			  <label><input type="radio" name="camSpecialEffect" value="1">Negative</label>
			  <label><input type="radio" name="camSpecialEffect" value="2">Grayscale</label>
			  <label><input type="radio" name="camSpecialEffect" value="3">Red Tint</label>
			  <label><input type="radio" name="camSpecialEffect" value="4">Green Tint</label>
			  <label><input type="radio" name="camSpecialEffect" value="5">Blue Tint</label>
			  <label><input type="radio" name="camSpecialEffect" value="6">Sepia</label>
			</div><br>

			<label for="camWBMode">White Balance Mode:</label>
			<div id="camWBModeGroup">
			  <label><input type="radio" name="camWBMode" value="0">Auto</label>
			  <label><input type="radio" name="camWBMode" value="1">Sunny</label>
			  <label><input type="radio" name="camWBMode" value="2">Cloudy</label>
			  <label><input type="radio" name="camWBMode" value="3">Office</label>
			  <label><input type="radio" name="camWBMode" value="4">Home</label>
			</div><br>

			<label for="camAELevel">AE Level:</label>
			<input type="range" min="-2" max="2" value="0" id="camAELevel" oninput="updateSliderValue('camAELevel')">
			<span id="camAELevelValue">0</span><br><br>
		  </div>
			<button onclick="applyCamSettings()" class="ctrlBtn" style="margin-top: 16px;">Apply</button>
		</div>




		  <!-- TELEMETRY TAB -->
		  <div id="telemetryTab" class="tabContent" style="display:none;">
			<h3>BNO055 Telemetry & Calibration</h3>
			<p>This shows current calibration status of the IMU. Values range from 0 (uncalibrated) to 3 (fully calibrated).</p>
			<table style="border-collapse: collapse; width: 100%; margin-top: 10px;">
			  <tr><th>System</th><th>Gyro</th><th>Accel</th><th>Magnet</th></tr>
			  <tr id="calibrationRow">
				<td id="sysCal">-</td>
				<td id="gyroCal">-</td>
				<td id="accelCal">-</td>
				<td id="magCal">-</td>
			  </tr>
			</table>
			<br>
			<button id="calibBtn" onclick="triggerCalibration()" class="ctrlBtn" style="margin-top: 16px;">Calibrate</button>
			<div id="calibStatus" style="margin-top: 10px; font-size: 90%; color: lightgreen;"></div>
		  </div>

		  <!-- WIFI TAB -->
		  <div id="wifiTab" class="tabContent" style="display:none;">
			<h3>Wi-Fi Setup</h3>
			<div style="display: flex;">
			  <!-- Left: Scanning and connect -->
			  <div style="flex: 1; padding-right: 10px; border-right: 1px solid #555;">
				<form method="POST" action="/savewifi">
				  <label for="ssidList">Select Wi-Fi:</label><br>
				  <select name="ssid" id="ssidList"></select><br><br>
				  <label for="password">Password:</label><br>
				  <input type="password" name="password" id="password"><br><br>
				  <input type="submit" value="Connect">
				</form>
				<button onclick="scanNetworks()">Scan Wi-Fi Networks</button>
			  </div>
			  <!-- Right: Saved networks -->
			  <div style="flex: 1; padding-left: 10px;">
				<h4>Saved Networks</h4>
				<div id="savedNetworksContainer">
				  <p>Loading saved networks...</p>
				</div>
			  </div>
			</div>
		  </div>

			<!-- MQTT TAB -->
			<div id="mqttTab" class="tabContent" style="display:none;">
				<h3>MQTT Integration</h3>
				<div style="margin-bottom:12px; color:#aac;">
					Configure connection to Home Assistant or another MQTT broker.
				</div>
			    <!-- --- MQTT STATUS: --- -->
			    <div id="mqttStatusBox" style="margin-bottom:14px;">
			  	  <span id="mqttStatusDot" style="font-size:1.2em;">🔴</span>
			  	  <span id="mqttStatusText" style="color:#d47;">Disconnected</span>
			    </div>				
				<label for="mqttEnable"><b>Enable MQTT:</b></label>
				<input type="checkbox" id="mqttEnable" style="margin-bottom:16px;"><br>
				
				<label for="mqttHost">Broker Address:</label><br>
				<input type="text" id="mqttHost" placeholder="e.g. 192.168.1.10" style="width:220px;"><br><br>
				
				<label for="mqttPort">Port:</label><br>
				<input type="number" id="mqttPort" value="1883" min="1" max="65535" style="width:100px;"><br><br>
				
				<label for="mqttUser">Username:</label><br>
				<input type="text" id="mqttUser" style="width:160px;"><br><br>
				
				<label for="mqttPass">Password:</label><br>
				<input type="password" id="mqttPass" style="width:160px;">
				<span id="mqttPassShow" style="cursor:pointer;margin-left:4px;">👁️</span>
				<br><br>
				
				<label for="mqttTopicPrefix">Base Topic Prefix:</label><br>
				<input type="text" id="mqttTopicPrefix" placeholder="e.g. robot01/" style="width:180px;"><br>
				<small style="color:#79e;">(Leave blank for no prefix; topics will be robot01/telemetry, robot01/cmd, etc.)</small>
				<br><br>
				<button id="mqttPublishDiscoveryBtn" class="ctrlBtn">📢 Publish Discovery</button>
				<button onclick="saveMqttSettings()" class="ctrlBtn">💾 Save</button>
				<button id="mqttTestBtn" class="ctrlBtn">🔄 Test Connection</button>
				<div id="mqttTerminal" class="mqtt-terminal"></div>
			</div>


			<!-- MEDIA TAB -->
			<div id="mediaTab" class="tabContent" style="display:none;">
				<h3>📷 Media Browser</h3>
				<div style="display:flex; gap:12px; margin-bottom:8px;">
					<label><input type="radio" name="mediaType" value="photo" checked> Photos</label>
					<label><input type="radio" name="mediaType" value="video"> Videos</label>
					<label><input type="radio" name="mediaType" value="audio"> Audio</label>
				</div>
				<div id="settingsMediaFileList" style="max-height:220px; overflow-y:auto; border:1px solid #345; border-radius:8px; margin-bottom:10px; background:#182030;"></div>
				<div id="mediaPreview" style="margin-top:16px;"></div>
			</div>


			<!-- SD CARD TAB -->
			<div id="sdTab" class="tabContent" style="display:none; height: 100%; padding-bottom:0;">
				<h3>📁 SD Card File Manager</h3>
				<div style="display: flex; flex-direction: column; height: calc(100% - 36px); min-height: 340px;">
					<div id="sd-capacity-bar" style="margin-bottom:8px;">
						<div id="sd-bar-label" style="font-size: 0.92em; margin-bottom: 2px;">Loading SD info...</div>
						<div style="width:100%; height:20px; background:#222; border-radius:6px; overflow:hidden;">
							<div id="sd-bar-used" style="background:#3993FF; height:100%; width:0%;"></div>
						</div>
					</div>
					<!-- Toolbar goes here, above scroll area -->
					<div id="sd-toolbar"></div>
					<!-- Path bar (NEW) -->
					<div id="sd-pathbar" style="margin:4px 0 6px 0; font-size:0.96em; color:#aac; word-break:break-all;"></div>
					<!-- File list is scrollable/flex-fills -->
					<div id="sdFileList" style="flex: 1 1 auto; overflow-y: auto; min-height: 80px;"></div>
					<!-- Hidden file input for replacements -->
					<input type="file" id="replaceFileInput" style="display:none;">
					<!-- Optional manual reboot -->
					<div class="sd-reboot-bar" style="padding: 14px 0 2px 0; text-align: right;">
						<button id="rebootBtn" class="ctrlBtn">🔁 Reboot ESP32</button>
					</div>
				</div>
			</div>



		  <!-- OTA TAB -->
		  <div id="otaTab" class="tabContent" style="display:none;">
			<div id="fwVersion" style="font-size:1.1em;font-weight:bold;margin-bottom:14px;">
			  Current Firmware: <span id="fwVersionNum">...</span>
			</div>
			<h3>OTA Update</h3>
			<form id="otaUploadForm" action="javascript:void(0);">
			  <input type="file" id="otaFile" required onchange="onFirmwareFileSelected()"><br>
			  <div id="versionCompare" style="display:none; margin-top: 6px;">
				📦 Selected: <b id="selectedVersion">-</b><br>
				🔧 Current: <b id="currentVersion">-</b><br><br>
			  </div>
			  <button type="button" onclick="checkForUpdates(true)">🔄 Check Online for Updates</button><br><br>
			  <button id="uploadBtn" type="button" onclick="uploadFirmware()" style="display:none;">⬆️ Upload Firmware</button>
			</form>
			<progress id="otaProgress" value="0" max="100" style="width:100%; display:none;"></progress>
			<div id="otaStatus"></div>
		  </div>

		  <!-- CONFIG TAB -->
		  <div id="robotTab" class="tabContent" style="display:none;">
			<h3>Robot/Interface Config</h3>
			<label for="darkToggle">🌙 Dark Mode</label>
			<input type="checkbox" id="darkToggle" onchange='toggleDarkMode(this.checked)'><br><br>
			<label for="horizontalToggle" style="font-size:20px;">HorizontalScreen:</label>
			<input type="checkbox" id="horizontalToggle" onchange='sendButtonInput("Switch", this.checked ? 1 : 0)'><br><br>
			<label for="holdBucketToggle" style="font-size:20px;">Hold Bucket:</label>
			<input type="checkbox" id="holdBucketToggle" onchange='sendButtonInput("HoldBucket", this.checked ? 1 : 0)'><br><br>
			<label for="holdAuxToggle" style="font-size:20px;">Hold AUX:</label>
			<input type="checkbox" id="holdAuxToggle" onchange='sendButtonInput("HoldAux", this.checked ? 1 : 0)'><br><br>
			<label for="recordTelemetryToggle" style="font-size:20px;">Record Telemetry:</label>
			<input type="checkbox" id="recordTelemetryToggle"><br><br>

			<label for="systemSoundsToggle" style="font-size:20px;">System Sounds:</label>
			<input type="checkbox" id="systemSoundsToggle"><br><br>

			<label for="systemVolume" style="font-size:20px;">System Volume:</label>
			<input type="range" id="systemVolume" min="0" max="21" value="15" style="width: 160px; vertical-align: middle;">
			<span id="systemVolumeLabel">15</span><br><br>

			
			<label for="gpioLeft">Left Motor GPIO:</label>
			<input type="number" id="gpioLeft" min="0" max="39"><br><br>
			<label for="gpioRight">Right Motor GPIO:</label>
			<input type="number" id="gpioRight" min="0" max="39"><br><br>
			<label for="gpioServo">Servo GPIO:</label>
			<input type="number" id="gpioServo" min="0" max="39"><br><br>
			<button onclick="saveRobotConfig()" class="ctrlBtn" style="margin-top: 16px;">Apply Config</button>
		  </div>

		<!-- OLED SETTINGS TAB -->
		<div id="oledTab" class="tabContent" style="display:none;">
		  <h3>OLED Display Customization</h3>

		  <label for="oledLayout">Layout Mode:</label>
		  <select id="oledLayout">
			<option value="default">Gears + Battery + WiFi</option>
			<option value="text">Text Messages</option>
			<option value="animation">Custom Animation</option>
		  </select><br><br>

		  <label><input type="checkbox" id="oledShowIP" checked> Show IP Address</label><br>
		  <label><input type="checkbox" id="oledShowBattery" checked> Show Battery</label><br>
		  <label><input type="checkbox" id="oledShowWiFi" checked> Show Wi-Fi Signal</label><br><br>

		  <div id="oledAnimationUpload" style="display:none;">
			<label>Upload Custom Animation (XBM/RLE):</label>
			<input type="file" id="oledAnimFile"><br><br>
			<button onclick="uploadOledAnimation()">📤 Upload Animation</button>
			<div id="oledAnimStatus" style="font-size: 90%; margin-top: 8px;"></div>
		  </div>

		  <button onclick="saveOledSettings()" class="ctrlBtn" style="margin-top: 16px;">💾 Save OLED Settings</button>
		  <div id="oledSaveStatus" style="margin-top:10px; font-size:90%; color:lightgreen;"></div>
		</div>

		  
	  </div>
	 </div>
		<!-- RESIZE HANDLES (8 directions) -->
		<div class="modal-resize-handle modal-resize-n"></div>
		<div class="modal-resize-handle modal-resize-e"></div>
		<div class="modal-resize-handle modal-resize-s"></div>
		<div class="modal-resize-handle modal-resize-w"></div>
		<div class="modal-resize-handle modal-resize-ne"></div>
		<div class="modal-resize-handle modal-resize-nw"></div>
		<div class="modal-resize-handle modal-resize-se"></div>
		<div class="modal-resize-handle modal-resize-sw"></div>		 
   </div>
</div>